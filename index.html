<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>REEL C - Console Anni '70</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Courier New', monospace;
      color: white;
      flex-direction: column;
      overflow: hidden;
    }
    canvas {
      border: 4px solid #0f0;
      image-rendering: pixelated;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
    }
    .container { text-align: center; }
    .scanlines {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      opacity: 0.15;
    }
    @media (max-width: 700px) {
      canvas { width: 90vw; height: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div id="menu">
      <h2>REEL C - CONSOLE 1978</h2>
      <p>1. TENNIS | 2. CALCIO | 3. PELOTA | 4. SQUASH</p>
      <p>P1 (S/X) | P2 (↑/↓)</p>
    </div>
  </div>
  <div class="scanlines" id="scanlines"></div>

  <script>
    // ========================================
    // Reel C - Console Anni '70 (Web Version)
    // Basato sulla versione aggiornata di Geppetto64
    // ========================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scanlines = document.getElementById('scanlines');
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    // Colori
    const BLACK = '#000000';
    const GREEN = '#00FF00';
    const WHITE = '#FFFFFF';
    const YELLOW = '#FFFF00';
    const ORANGE = '#FFA500';

    // Font
    const FONT = '16px monospace';
    const SCORE_FONT = '76px monospace';
    const VICTORY_FONT = '100px monospace';
    const GOAL_FONT = '140px monospace';

    // Audio Context
    let audioCtx;
    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playTone(freq, dur, type = 'square') {
      if (!audioCtx) initAudio();
      const osc = audioCtx.createOscillator();
      const amp = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      amp.gain.setValueAtTime(0.1, audioCtx.currentTime);
      amp.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      osc.connect(amp);
      amp.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
    }

    function playPaddleHit() { playTone(523, 0.06); }
    function playWallBounce() { playTone(392, 0.08); }
    function playPointScore() { playTone(220, 0.15); }
    function playGoalSound() {
      [659, 784, 1047, 1318].forEach((f, i) => setTimeout(() => playTone(f, 0.1), i * 100));
    }
    function playVictoryJingle() {
      [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.15), i * 150));
    }

    // Effetto CRT (scanlines)
    function createScanlines() {
      let lines = '';
      for (let y = 0; y < HEIGHT; y += 2) {
        lines += `<div style="position:absolute; top:${y}px; left:0; right:0; height:1px; background:black; opacity:0.5;"></div>`;
      }
      scanlines.innerHTML = lines;
    }
    createScanlines();

    // Gestione tasti
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    // Classi dei giochi (es. Tennis con pausa e set)
    class Game {
      constructor() {
        this.running = true;
        this.fps = 30;
        this.lastTime = 0;
      }
      draw() {}
      update() {}
      handleInput() {}
      run(timestamp) {
        if (!this.running) return;
        const elapsed = timestamp - this.lastTime;
        if (elapsed > 1000 / this.fps) {
          this.handleInput();
          this.update();
          ctx.fillStyle = BLACK;
          ctx.fillRect(0, 0, WIDTH, HEIGHT);
          this.draw();
          this.lastTime = timestamp;
        }
        requestAnimationFrame((t) => this.run(t));
      }
    }

    class Tennis extends Game {
      constructor() {
        super();
        this.paddleWidth = 8;
        this.paddleHeight = 66;
        this.speed = 7;
        this.paddle1Y = HEIGHT / 2 - this.paddleHeight / 2;
        this.paddle2Y = HEIGHT / 2 - this.paddleHeight / 2;
        this.scoreP1 = 0;
        this.scoreP2 = 0;
        this.level = 1;
        this.winsP1 = 0;
        this.winsP2 = 0;
        this.matchOver = false;
        this.matchWinner = null;
        this.waitingStart = true;
        this.showStarterMsg = false;
        this.starter = null;
        this.paused = false;
        this.showLevelMsg = false;
        this.levelMsgTime = 0;
        this.ball = {
          x: WIDTH / 2,
          y: HEIGHT / 2,
          speedX: 0,
          speedY: 0,
          radius: 6
        };
        this.reset();
      }
      reset() {
        const baseSpeed = 5;
        const levelMult = 1 + 0.15 * (this.level - 1);
        const mag = baseSpeed * levelMult;
        this.ball.speedX = Math.random() > 0.5 ? -mag : mag;
        this.ball.speedY = Math.random() > 0.5 ? -mag : mag;
        this.ball.x = WIDTH / 2;
        this.ball.y = HEIGHT / 2;
      }
      draw() {
        ctx.strokeStyle = WHITE;
        ctx.strokeRect(0, 0, WIDTH, HEIGHT);
        for (let y = 0; y < HEIGHT; y += 20) {
          ctx.fillRect(WIDTH / 2 - 2, y, 4, 10);
        }
        ctx.fillStyle = GREEN;
        ctx.fillRect(10, this.paddle1Y, this.paddleWidth, this.paddleHeight);
        ctx.fillStyle = WHITE;
        ctx.fillRect(WIDTH - 20 - this.paddleWidth, this.paddle2Y, this.paddleWidth, this.paddleHeight);
        ctx.fillStyle = WHITE;
        ctx.beginPath();
        ctx.arc(this.ball.x, this.ball.y, this.ball.radius, 0, Math.PI * 2);
        ctx.fill();
        this.drawScoreboard();
        ctx.font = FONT;
        ctx.fillStyle = YELLOW;
        ctx.fillText(`Livello: ${this.level}`, WIDTH - 120, 10);
        ctx.fillStyle = WHITE;
        ctx.fillText(`Vittorie - Verde: ${this.winsP1} Bianco: ${this.winsP2}`, 10, 10);

        if (this.showLevelMsg && Date.now() - this.levelMsgTime < 3000) {
          const levelFont = '28px monospace';
          ctx.font = levelFont;
          const msg = `LIVELLO ${this.level}`;
          const w = ctx.measureText(msg).width;
          ctx.fillStyle = WHITE;
          ctx.fillText(msg, (WIDTH - w) / 2, HEIGHT / 2);
        }

        if (this.matchOver && this.matchWinner) {
          const color = this.matchWinner === 'p1' ? GREEN : WHITE;
          const blink = Math.floor(Date.now() / 500) % 2 === 0;
          ctx.font = VICTORY_FONT;
          ctx.fillStyle = blink ? color : YELLOW;
          const win = ctx.measureText("VITTORIA:");
          ctx.fillText("VITTORIA:", (WIDTH - win.width) / 2, HEIGHT / 2 - 40);
          ctx.fillStyle = color;
          const player = ctx.measureText(this.matchWinner === 'p1' ? "VERDE" : "BIANCO");
          ctx.fillText(this.matchWinner === 'p1' ? "VERDE" : "BIANCO", (WIDTH - player.width) / 2, HEIGHT / 2 + 20);
          ctx.font = FONT;
          const cont = ctx.measureText("ESC per uscire");
          ctx.fillStyle = WHITE;
          ctx.fillText("ESC per uscire", (WIDTH - cont.width) / 2, HEIGHT / 2 + 70);
        }

        if (this.waitingStart) {
          ctx.fillStyle = YELLOW;
          ctx.fillText("Premere G per iniziare gioco", WIDTH / 2 - 100, 90);
          ctx.fillStyle = ORANGE;
          ctx.fillText("Premere P per pausa gioco e ripremere P per continuare", WIDTH / 2 - 220, 120);
          if (this.showStarterMsg) {
            const col = this.starter === 'p1' ? GREEN : WHITE;
            const txt = this.starter === 'p1' ? "VERDE" : "BIANCO";
            ctx.fillStyle = col;
            ctx.fillText(`Inizia il giocatore: ${txt}`, WIDTH / 2 - 100, 150);
          }
        }

        if (this.paused) {
          ctx.fillStyle = ORANGE;
          ctx.fillText("GIOCO IN PAUSA", WIDTH / 2 - 70, HEIGHT / 2);
        }
      }
      update() {
        if (this.waitingStart || this.paused) return;

        this.ball.x += this.ball.speedX;
        this.ball.y += this.ball.speedY;

        if (this.ball.y <= 0 || this.ball.y >= HEIGHT) {
          this.ball.speedY *= -1;
          playWallBounce();
        }

        if (this.ball.x <= 20 && this.paddle1Y <= this.ball.y && this.ball.y <= this.paddle1Y + this.paddleHeight) {
          this.ball.speedX *= -1.1;
          playPaddleHit();
        }
        if (this.ball.x >= WIDTH - 20 && this.paddle2Y <= this.ball.y && this.ball.y <= this.paddle2Y + this.paddleHeight) {
          this.ball.speedX *= -1.1;
          playPaddleHit();
        }

        if (this.ball.x < 0) {
          this.scoreP2++;
          playPointScore();
          this.checkSet();
        }
        if (this.ball.x > WIDTH) {
          this.scoreP1++;
          playPointScore();
          this.checkSet();
        }

        if (keys['s'] && this.paddle1Y > 0) this.paddle1Y -= this.speed;
        if (keys['x'] && this.paddle1Y < HEIGHT - this.paddleHeight) this.paddle1Y += this.speed;
        if (keys['arrowup'] && this.paddle2Y > 0) this.paddle2Y -= this.speed;
        if (keys['arrowdown'] && this.paddle2Y < HEIGHT - this.paddleHeight) this.paddle2Y += this.speed;
      }
      checkSet() {
        if (this.scoreP1 >= 7) {
          this.winsP1++;
          this.level++;
          this.showLevelMsg = true;
          this.levelMsgTime = Date.now();
          this.resetScores();
        } else if (this.scoreP2 >= 7) {
          this.winsP2++;
          this.level++;
          this.showLevelMsg = true;
          this.levelMsgTime = Date.now();
          this.resetScores();
        }
        if (this.winsP1 >= 3) {
          this.matchOver = true;
          this.matchWinner = 'p1';
          playVictoryJingle();
        } else if (this.winsP2 >= 3) {
          this.matchOver = true;
          this.matchWinner = 'p2';
          playVictoryJingle();
        }
        this.reset();
      }
      resetScores() {
        this.scoreP1 = 0;
        this.scoreP2 = 0;
      }
      handleInput() {
        document.addEventListener('keydown', (e) => {
          if (e.key.toLowerCase() === 'g' && this.waitingStart) {
            this.starter = Math.random() > 0.5 ? 'p1' : 'p2';
            this.showStarterMsg = true;
            this.waitingStart = false;
            setTimeout(() => this.showStarterMsg = false, 2000);
          }
          if (e.key.toLowerCase() === 'p' && !this.waitingStart) {
            this.paused = !this.paused;
          }
          if (e.key === 'Escape') this.running = false;
        }, { once: false });
      }
      drawScoreboard() {
        const s1 = this.scoreP1.toString();
        const s2 = this.scoreP2.toString();
        ctx.font = SCORE_FONT;
        ctx.fillStyle = WHITE;
        const w1 = ctx.measureText(s1).width;
        const w2 = ctx.measureText(s2).width;
        const colon = ctx.measureText(":").width;
        const total = w1 + colon + w2 + 40;
        const startX = (WIDTH - total) / 2;
        ctx.fillText(s1, startX, 80);
        ctx.fillText(":", startX + w1 + 20, 80);
        ctx.fillText(s2, startX + w1 + 20 + colon + 20, 80);

        ctx.font = '16px monospace';
        ctx.fillStyle = GREEN;
        ctx.fillText("VERDE", startX + (w1 - 40) / 2, 20);
        ctx.fillStyle = WHITE;
        ctx.fillText("BIANCO", startX + w1 + 20 + colon + 20 + (w2 - 50) / 2, 20);
      }
    }

    // Funzioni di menu
    function showMenu() {
      ctx.fillStyle = BLACK;
      ctx.fillRect(0, 0, WIDTH, HEIGHT);
      ctx.font = '30px monospace';
      ctx.fillStyle = WHITE;
      ctx.fillText("REEL C - CONSOLE 1978", WIDTH / 2 - 200, 100);
      ctx.font = '20px monospace';
      const opts = ["1. TENNIS", "2. CALCIO", "3. PELOTA", "4. SQUASH", "ESC - Uscita"];
      opts.forEach((opt, i) => {
        ctx.fillStyle = i === 0 ? GREEN : WHITE;
        ctx.fillText(opt, WIDTH / 2 - 100, 150 + i * 40);
      });
    }

    // Boot sequence
    function bootSequence() {
      ctx.fillStyle = BLACK;
      ctx.fillRect(0, 0, WIDTH, HEIGHT);
      ctx.font = '40px monospace';
      ctx.fillStyle = GREEN;
      ctx.fillText("REEL C", WIDTH / 2 - 80, HEIGHT / 2 - 40);
      ctx.fillText("1978", WIDTH / 2 - 50, HEIGHT / 2);
      ctx.font = '20px monospace';
      ctx.fillText("LOADING...", WIDTH / 2 - 70, HEIGHT / 2 + 40);
      playPointScore();
      setTimeout(() => {
        ctx.fillStyle = BLACK;
        ctx.fillRect(0, 0, WIDTH, HEIGHT);
        ctx.fillStyle = GREEN;
        ctx.fillText("READY TO PLAY", WIDTH / 2 - 100, HEIGHT / 2);
        playPaddleHit();
      }, 1500);
    }

    // Avvio
    bootSequence();
    setTimeout(() => {
      showMenu();
      document.addEventListener('keydown', function(e) {
        if (e.key === '1') {
          const game = new Tennis();
          game.run();
        } else if (e.key === 'Escape') {
          showMenu();
        }
      });
    }, 2000);
  </script>
</body>
</html>